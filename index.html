<!DOCTYPE html>
<html lang="no" class="h-full bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanse Data</title>
    <!-- Laster inn Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Egendefinert stil for å matche Dash-appen */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; }
        .filter-button { background-color: transparent; color: #fff; border: 1px solid rgba(255, 255, 255, 0.3); padding: 5px 14px; border-radius: 9999px; font-size: 13px; font-weight: 500; transition: all 0.2s ease; cursor: pointer; white-space: nowrap; text-align: center; }
        .filter-button:hover { background-color: rgba(255, 255, 255, 0.1); }
        .filter-button.active { background-color: #10b981; color: white; border-color: transparent; }
        .name-input { background-color: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; font-size: 0.875rem;}
        .name-input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px #10b98140; }
        .table-input { background-color: #374151; border: 1px solid #4a5568; color: white; border-radius: 0.375rem; padding: 0.25rem 0.5rem; width: 100%; font-size: 0.875rem;}
        .table-input:focus { outline: none; border-color: #10b981; }
        .icon-button { background: none; border: none; color: #9ca3af; cursor: pointer; transition: color 0.2s; }
        .icon-button:hover { color: #10b981; }
        .icon-button-delete:hover { color: #ef4444; }
        
        /* Laster-spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
        }
        
        /* --- NY STYLING FOR MODAL --- */
        #modal-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #4a5568; /* border-gray-600 */
        }
        .age-card {
            background-color: #2d3748; /* bg-gray-800 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            text-align: center;
        }
        .age-card-title {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #9ca3af; /* text-gray-400 */
            margin-bottom: 0.25rem;
        }
        .age-card-value {
            display: block;
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
        }
        .text-balance { color: #34d399; } /* emerald-400 */
        .text-function { color: #60a5fa; } /* blue-400 */
        .text-strength { color: #a78bfa; } /* purple-400 */
        /* --- SLUTT PÅ NY STYLING --- */

    </style>
</head>
<body class="h-full bg-black text-gray-300">

    <!-- Laste-overlay -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-message">Kobler til database...</p>
    </div>

    <!-- Balansealder Modal -->
    <div id="age-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-[#1a1c1f] border border-gray-700 p-6 rounded-lg max-w-lg w-full text-center shadow-2xl">
            <h3 id="modal-title" class="text-2xl text-white font-semibold mb-4">Balansealder Beregnet</h3>
            <p id="modal-message" class="text-lg text-gray-300 mb-2">Din estimerte balansealder er:</p>
            <p id="modal-balance-age" class="text-5xl font-bold text-emerald-400 mb-6"></p>
            
            <!-- NY: Seksjon for fulle fitness-detaljer -->
            <div id="modal-details">
                <!-- Fylles av JS -->
            </div>

            <button id="close-modal-btn" class="filter-button active w-full !mt-6">Lukk</button>
        </div>
    </div>

    <!-- Hovedinnhold -->
    <div class="max-w-7xl mx-auto p-6">
        <img src="https://storage.googleapis.com/files_webpage/narrow.png" class="h-8 w-auto mb-6">
        <h1 class="text-3xl text-center text-white mb-8 font-light">Balanse Data Logger</h1>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Venstre kolonne (Kontroller) -->
            <div class="lg:w-1/3 flex flex-col gap-6">

                <!-- Panel: Testleder -->
                <div class="bg-[#1a1c1f] border border-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg text-white font-semibold mb-4">Testleder</h3>
                    <div class="bg-gray-800/40 p-4 rounded-lg">
                        <div>
                            <label for="testleder-input" class="block text-sm text-white font-medium mb-2">Ditt navn</label>
                            <input type="text" id="testleder-input" class="name-input" placeholder="Skriv inn ditt navn...">
                        </div>
                    </div>
                </div>

                <!-- Panel: Legg til data -->
                <div class="bg-[#1a1c1f] border border-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg text-white font-semibold mb-4">Legg til data</h3>
                    <!-- Indre panel for selve skjemaet -->
                    <div class="bg-gray-800/40 p-4 rounded-lg">
                        <h4 class="text-md text-white font-medium mb-4">Testperson-data</h4>
                        <form id="add-entry-form" class="space-y-4">
                            <div>
                                <label for="alder" class="block text-sm text-white font-medium mb-2">Alder</label>
                                <input type="number" id="alder" class="name-input" placeholder="F.eks. 25" required>
                            </div>
                            <div>
                                <label for="kjonn" class="block text-sm text-white font-medium mb-2">Kjønn</label>
                                <select id="kjonn" class="name-input">
                                    <option value="Mann">Mann</option>
                                    <option value="Kvinne">Kvinne</option>
                                    <option value="Annet">Annet</option>
                                </select>
                            </div>
                            <div>
                                <label for="areal" class="block text-sm text-white font-medium mb-2">Areal (cm²)</label>
                                <input type="number" step="0.01" id="areal" class="name-input" placeholder="F.eks. 4.72" required>
                            </div>
                            <div>
                                <label for="diff" class="block text-sm text-white font-medium mb-2">Diff (cm)</label>
                                <input type="number" step="0.01" id="diff" class="name-input" placeholder="F.eks. 1.20" required>
                            </div>

                            <!-- NY: Knapp for å vise fulle fitness-felt -->
                            <button type="button" id="toggle-fitness-btn" class="filter-button w-full !mt-6">
                                Full Fitness Age Report
                            </button>

                            <!-- NY: Skjulte felt for full fitness report -->
                            <div id="full-fitness-fields" class="hidden space-y-4 pt-4 border-t border-gray-700">
                                <div>
                                    <label for="hopphoyde" class="block text-sm text-white font-medium mb-2">Hopphøyde (cm)</label>
                                    <input type="number" step="0.1" id="hopphoyde" class="name-input" placeholder="F.eks. 35.5">
                                </div>
                                <div>
                                    <label for="vekt" class="block text-sm text-white font-medium mb-2">Kroppsvekt (kg)</label>
                                    <input type="number" step="0.1" id="vekt" class="name-input" placeholder="F.eks. 80">
                                </div>
                                <div>
                                    <label for="pullResultat" class="block text-sm text-white font-medium mb-2">Pull Resultat (kg)</label>
                                    <input type="number" step="0.1" id="pullResultat" class="name-input" placeholder="F.eks. 120">
                                </div>
                            </div>
                            <!-- Slutt på skjulte felt -->

                            <button type="submit" id="submit-button" class="filter-button active w-full !mt-6">
                                Legg til oppføring
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Panel: Instruksjoner -->
                <div class="bg-[#1a1c1f] border border-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg text-white font-semibold mb-4">Instruksjoner</h3>
                    <div class="bg-gray-800/40 p-4 rounded-lg text-sm space-y-2">
                        <p>Instruksjoner til balansetest:</p>
                        <ul class="list-disc list-inside pl-2">
                            <li>Løft foten ca. 10 cm fra bakken.</li>
                            <li>Hold armene ned langs siden av kroppen.</li>
                            <li>Se rett frem og stå så stille som mulig.</li>
                            <li>Stå i 30 sekunder på høyre fot og deretter 30 sekunder på venstre fot.</li>
                            <li>Uten sko.</li>
                        </ul>
                    </div>
                </div>

                <!-- Panel: Statistikk -->
                <div class="bg-[#1a1c1f] border border-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg text-white font-semibold mb-4">Statistikk</h3>
                    <div class="bg-gray-800/40 p-4 rounded-lg space-y-3">
                        <div>
                            <span class="font-medium text-white">Totalt antall:</span>
                            <span id="total-count" class="font-bold text-xl text-emerald-400 ml-2">0</span>
                        </div>
                        
                        <!-- Kjønnsfordeling -->
                        <div class="border-t border-gray-600 pt-3">
                            <h5 class="text-sm text-white font-medium mb-2">Kjønnsfordeling:</h5>
                            <div id="gender-stats" class="text-sm space-y-1">
                                <p class="text-gray-400">Laster data...</p>
                            </div>
                        </div>

                        <!-- Aldersgrupper -->
                        <div class="border-t border-gray-600 pt-3">
                            <h5 class="text-sm text-white font-medium mb-2">Aldersgrupper:</h5>
                            <div id="age-group-stats" class="text-sm space-y-1">
                                <p class="text-gray-400">Laster data...</p>
                            </div>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Høyre kolonne (Tabell) -->
            <div class="lg:w-2/3">
                <div class="bg-[#1a1c1f] border border-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg text-white font-semibold mb-4">Innsamlet Data</h3>
                    
                    <!-- Filter og Last ned -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="filter-input" class="name-input flex-grow" placeholder="Filtrer på testleder...">
                        <button id="download-csv-button" class="filter-button active !bg-blue-600 hover:!bg-blue-700 border-transparent whitespace-nowrap">
                            Last ned CSV
                        </button>
                    </div>

                    <!-- Tabell-wrapper -->
                    <div class="max-h-[800px] overflow-y-auto overflow-x-auto rounded-lg border border-gray-700">
                        <table class="w-full min-w-max text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-800/40 sticky top-0">
                                <tr>
                                    <!-- NY: Kolonne for rapport-ikon -->
                                    <th scope="col" class="py-3 px-4 text-center">Rapport</th>
                                    <th scope="col" class="py-3 px-4">Testleder</th>
                                    <th scope="col" class="py-3 px-4">Alder</th>
                                    <th scope="col" class="py-3 px-4">Kjønn</th>
                                    <th scope="col" class="py-3 px-4">Areal (cm²)</th>
                                    <th scope="col" class="py-3 px-4">Diff (cm)</th>
                                    <th scope="col" class="py-3 px-4">Balansealder</th>
                                    <th scope="col" class="py-3 px-4">Tidsstempel</th>
                                    <th scope="col" class="py-3 px-4 text-center">Handling</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-gray-700">
                                <!-- Fylles av JS -->
                                <tr>
                                    <!-- OPPDATERT: Colspan til 9 -->
                                    <td colspan="9" class="py-4 px-6 text-center text-gray-500">
                                        Laster data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importer nødvendige Firebase-moduler
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            onSnapshot, 
            deleteDoc, 
            updateDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Hardkodet Firebase-konfigurasjon for 'balanse-data'
        const firebaseConfig = {
            apiKey: "AIzaSyCIYqq1_2eKdBw3u_FYUIFvo6VnJcLVliA",
            authDomain: "balanse-data.firebaseapp.com",
            projectId: "balanse-data",
            storageBucket: "balanse-data.firebasestorage.app",
            messagingSenderId: "582679675587",
            appId: "1:582679675587:web:65e683192e7afca4799876",
            measurementId: "G-4RZ4FV30VF"
        };
        
        // Globale variabler
        let db;
        let entriesCollection;
        let allEntries = []; // Sørger for at den er en liste fra start
        let unsubscribeEntries = null; // For å stoppe lytteren

        // UI-elementer
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const dataTableBody = document.getElementById('data-table-body');
        const filterInput = document.getElementById('filter-input');
        const addForm = document.getElementById('add-entry-form');
        const testlederInput = document.getElementById('testleder-input');
        const totalCountEl = document.getElementById('total-count');
        const genderStatsEl = document.getElementById('gender-stats'); // Ny
        const ageGroupStatsEl = document.getElementById('age-group-stats');
        const downloadCsvButton = document.getElementById('download-csv-button');
        // UI-elementer for Modal
        const ageModal = document.getElementById('age-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalBalanceAge = document.getElementById('modal-balance-age');
        const modalDetails = document.getElementById('modal-details'); // NY
        const closeModalBtn = document.getElementById('close-modal-btn');
        // UI for Full Fitness Report
        const toggleFitnessBtn = document.getElementById('toggle-fitness-btn');
        const fitnessFields = document.getElementById('full-fitness-fields');

        // --- START: INNPORTET LOGIKK FOR FITNESS AGE ---
        const JUMP_DATA_MENN = [
             // OPPDATERT: +5cm lagt til
             { label:"8–9",   p5:24.0, p25:27.6, p50:30.8, p75:34.4, p95:39.5 },
             { label:"10–11", p5:25.8, p25:30.4, p50:34.2, p75:38.4, p95:42.9 },
             { label:"12–13", p5:27.8, p25:33.6, p50:37.7, p75:42.4, p95:50.6 },
             { label:"14–15", p5:29.4, p25:36.6, p50:41.1, p75:45.8, p95:53.0 },
             { label:"16–17", p5:29.8, p25:38.6, p50:44.3, p75:49.1, p95:57.4 },
             { label:"18–19", p5:32.2, p25:40.0, p50:45.6, p75:51.2, p95:59.2 },
             { label:"20–24", p5:30.8, p25:38.8, p50:44.4, p75:50.0, p95:58.2 },
             { label:"25–29", p5:29.5, p25:37.2, p50:42.4, p75:47.6, p95:55.1 },
             { label:"30–34", p5:28.2, p25:35.2, p50:40.0, p75:44.6, p95:51.8 },
             { label:"35–39", p5:26.8, p25:33.0, p50:37.6, p75:41.9, p95:48.4 },
             { label:"40–44", p5:25.6, p25:31.2, p50:35.1, p75:39.1, p95:45.2 },
             { label:"45–49", p5:20.1, p25:29.3, p50:32.8, p75:36.9, p95:42.6 },
             { label:"50–59", p5:17.8, p25:21.2, p50:24.7, p75:27.8, p95:33.7 },
             { label:"60–69", p5:16.7, p25:19.6, p50:22.15,p75:24.9, p95:30.2 },
             { label:"70–80", p5:10.0, p25:17.9, p50:19.7, p75:23.0, p95:27.6 }
        ];
        const JUMP_DATA_KVINNER = [
             // DATA OPPDATERT BASERT PÅ BILDE (2025-10-28) - OG REDUSERT MED 3 CM
             { label:"8–9",   p5:13.0, p25:16.8, p50:19.4, p75:22.3, p95:26.4 },
             { label:"10–11", p5:15.5, p25:19.2, p50:22.8, p75:25.9, p95:30.2 },
             { label:"12–13", p5:15.8, p25:20.4, p50:23.6, p75:27.0, p95:32.0 },
             { label:"14–15", p5:15.5, p25:20.5, p50:23.6, p75:26.9, p95:31.6 },
             { label:"16–17", p5:15.0, p25:19.4, p50:22.8, p75:26.2, p95:31.3 },
             { label:"18–19", p5:14.9, p25:19.2, p50:22.3, p75:25.6, p95:30.4 },
             { label:"20–24", p5:14.0, p25:18.0, p50:21.4, p75:24.8, p95:29.5 },
             { label:"25–29", p5:13.2, p25:17.0, p50:20.2, p75:23.4, p95:28.4 },
             { label:"30–34", p5:12.6, p25:16.2, p50:19.2, p75:22.2, p95:27.0 },
             { label:"35–39", p5:12.0, p25:15.4, p50:18.2, p75:21.2, p95:25.8 },
             { label:"40–44", p5:7.0,  p25:14.5, p50:17.0, p75:19.9, p95:24.6 },
             { label:"45–49", p5:6.5,  p25:13.8, p50:16.4, p75:18.9, p95:23.2 },
             // GAMLE FALLBACK-DATA FOR ALDRE OVER 49 (IKKE I BILDET) - OG REDUSERT MED 3 CM
             { label:"50–59", p5:6.0,  p25:9.0,  p50:12.5, p75:16.0, p95:20.0 },
             { label:"60–69", p5:5.0,  p25:7.5,  p50:10.0, p75:13.0, p95:17.0 },
             { label:"70–80", p5:0.0,  p25:5.5,  p50:7.5,  p75:10.5, p95:14.0 } // p5 cappeet på 0
        ];

        const STRENGTH_MODEL = {
          male: { slope: 0.9607, intercept: 0.9399 },
          female: { slope: 0.7710, intercept: 1.4416 },
          ageGroupAdjustments: {
            "Under 10_m": { mean: 0.9098, stdDev: 0.1822 }, "10-19_m": { mean: 1.0061, stdDev: 0.1676 },
            "20-29_m": { mean: 1.0554, stdDev: 0.1545 }, "30-39_m": { mean: 1.0463, stdDev: 0.1411 },
            "40-49_m": { mean: 1.0234, stdDev: 0.1382 }, "50-59_m": { mean: 0.9800, stdDev: 0.1626 },
            "60-69_m": { mean: 0.8587, stdDev: 0.1127 }, "70-79_m": { mean: 0.7195, stdDev: 0.1766 },
             "80+_m": { mean: 0.69, stdDev: 0.17 }, // Added estimate for 80+ male
            "Under 10_f": { mean: 0.8631, stdDev: 0.1100 }, "10-19_f": { mean: 1.0489, stdDev: 0.1200 },
            "20-29_f": { mean: 1.1283, stdDev: 0.1625 }, "30-39_f": { mean: 1.1265, stdDev: 0.1728 },
            "40-49_f": { mean: 1.1329, stdDev: 0.2453 }, "50-59_f": { mean: 1.0346, stdDev: 0.1595 },
            "60-69_f": { mean: 0.8233, stdDev: 0.1264 }, "70-79_f": { mean: 0.6725, stdDev: 0.1072 },
            "80+_f": { mean: 0.7410, stdDev: 0.1461 }
          },
          overall: { mean: 1.0168, stdDev: 0.1808 }
        };

        function getAgeGroupData(age, sex) {
            const dataSet = sex.toLowerCase() === 'kvinne' ? JUMP_DATA_KVINNER : JUMP_DATA_MENN;
            if (age <= 9) return dataSet[0];
            if (age <= 11) return dataSet[1];
            if (age <= 13) return dataSet[2];
            if (age <= 15) return dataSet[3];
            if (age <= 17) return dataSet[4];
            if (age <= 19) return dataSet[5];
            if (age <= 24) return dataSet[6];
            if (age <= 29) return dataSet[7];
            if (age <= 34) return dataSet[8];
            if (age <= 39) return dataSet[9];
            if (age <= 44) return dataSet[10];
            if (age <= 49) return dataSet[11];
            if (age <= 59) return dataSet[12];
            if (age <= 69) return dataSet[13];
            return dataSet[14]; // 70+
        }

        function calculateJumpPercentile(age, sex, jumpHeight) {
             if (!isFinite(jumpHeight) || !isFinite(age)) return NaN;
             const g = getAgeGroupData(age, sex);
             const pts = [ {p:5, x:g.p5}, {p:25, x:g.p25}, {p:50, x:g.p50}, {p:75, x:g.p75}, {p:95, x:g.p95} ];
             if (jumpHeight <= pts[0].x) {
                 const m = (pts[1].p - pts[0].p) / (pts[1].x - pts[0].x || 1e-6);
                 return Math.max(0.1, pts[0].p + (jumpHeight - pts[0].x) * m);
             }
             for (let i = 0; i < pts.length - 1; i++) {
                 if (jumpHeight <= pts[i+1].x) {
                     const m = (pts[i+1].p - pts[i].p) / (pts[i+1].x - pts[i].x || 1e-6);
                     return pts[i].p + (jumpHeight - pts[i].x) * m;
                 }
             }
             const m = (pts[pts.length-1].p - pts[pts.length-2].p) / (pts[pts.length-1].x - pts[pts.length-2].x || 1e-6);
             return Math.min(99.9, pts[pts.length-1].p + (jumpHeight - pts[pts.length-1].x) * m);
        }
        
        // NY LOGIKK: P0 = Alder+5, P50 = Alder, P100 = 21
        function calculateAgeFromPercentile(percentile, realAge, minAge = 21) {
            if (!isFinite(percentile) || !isFinite(realAge)) return NaN;
            const p = Math.max(0, Math.min(100, percentile));
            const maxAge = realAge + 5; // P0 = Alder + 5
            
            if (p === 50) {
                return realAge;
            } else if (p > 50) {
                // Mellom P50 (realAge) og P100 (minAge)
                const factor = (p - 50) / 50; // 0 til 1
                return realAge - factor * (realAge - minAge);
            } else {
                // Mellom P0 (maxAge) og P50 (realAge)
                const factor = p / 50; // 0 til 1
                return maxAge - factor * (maxAge - realAge);
            }
        }
        
        function calculateJumpAge(realAge, sex, jumpHeight) {
            const percentile = calculateJumpPercentile(realAge, sex, jumpHeight);
            return calculateAgeFromPercentile(percentile, realAge, 21); // Bruker 21 som min alder
        }

        function getStrengthAgeGroup(age) {
            if (age < 10) return 'Under 10'; if (age < 20) return '10-19';
            if (age < 30) return '20-29'; if (age < 40) return '30-39';
            if (age < 50) return '40-49'; if (age < 60) return '50-59';
            if (age < 70) return '60-69'; if (age < 80) return '70-79';
            return '80+';
        }

        function calculateStrengthScoreAndPercentile(gender, age, weight, pull) {
            if (!isFinite(age) || !isFinite(weight) || !isFinite(pull) || weight <= 0 || pull < 0) {
                return { score: NaN, percentile: NaN, error: "Invalid input values" };
            }
            try {
                const genderKey = gender.toLowerCase() === 'kvinne' ? 'female' : 'male';
                const model = STRENGTH_MODEL[genderKey];
                const expectedLogPull = model.intercept + model.slope * Math.log(weight);
                const expectedPull = Math.exp(expectedLogPull);
                if (!isFinite(expectedPull) || expectedPull <= 0) {
                     return { score: NaN, percentile: NaN, error: "Calculation error (expected pull)" };
                }
                const strengthRatio = pull / expectedPull;
                const ageGroup = getStrengthAgeGroup(age);
                const groupKey = `${ageGroup}_${genderKey === 'female' ? 'f' : 'm'}`;
                let groupStats = STRENGTH_MODEL.ageGroupAdjustments[groupKey];
                let zScore = 0;
                if (groupStats && groupStats.stdDev > 0) {
                    zScore = (strengthRatio - groupStats.mean) / groupStats.stdDev;
                } else if (STRENGTH_MODEL.overall.stdDev > 0) {
                    groupStats = STRENGTH_MODEL.overall;
                    zScore = (strengthRatio - groupStats.mean) / groupStats.stdDev;
                } else {
                     return { score: NaN, percentile: NaN, error: "Calculation error (std dev zero)" };
                }
                const percentile = 50.0 * (1 + (zScore / Math.sqrt(2)) / Math.abs(zScore / Math.sqrt(2)) * Math.sqrt(1 - Math.exp(-2 * zScore * zScore / Math.PI)));
                const clampedPercentile = Math.max(0, Math.min(100, percentile)); // Rettet typo her
                let finalScore = 50 + (zScore * 15);
                finalScore = Math.max(0, Math.min(100, finalScore));
                return { score: finalScore, percentile: clampedPercentile };
            } catch (error) {
                 return { score: NaN, percentile: NaN, error: "Calculation failed" };
            }
        }
        
        function calculateStrengthAgeFromPercentile(percentile, realAge) {
             return calculateAgeFromPercentile(percentile, realAge, 21); // Bruker 21 som min alder
        }
        // --- SLUTT: INNPORTET LOGIKK ---


        /**
         * Viser en popup-modal med tilpasset innhold.
         * @param {string} title - Tittelen på modalen
         * @param {string} message - Hovedmeldingen
         * @param {string} value - Verdien som skal vises (f.eks. alder)
         * @param {string} type - 'success', 'error', 'warning', 'info'
         * @param {string} detailsHtml - (Valgfri) HTML for de nye detalj-boksene
         */
        function showModal(title, message, value, type = 'success', detailsHtml = "") {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalBalanceAge.textContent = value;
            
            // Fyll inn eller tøm detalj-seksjonen
            modalDetails.innerHTML = detailsHtml;
            
            // Tilpass synlighet basert på om detaljer finnes
            modalDetails.style.display = detailsHtml ? "grid" : "none";
            modalBalanceAge.style.marginBottom = detailsHtml ? "0" : "1.5rem"; // 24px
            
            // Tilbakestill farger
            modalBalanceAge.classList.remove('text-emerald-400', 'text-red-500', 'text-yellow-400', 'text-blue-400');

            if (type === 'success') {
                modalBalanceAge.classList.add('text-emerald-400');
            } else if (type === 'error') {
                modalBalanceAge.classList.add('text-red-500');
            } else if (type === 'warning') {
                modalBalanceAge.classList.add('text-yellow-400');
            } else if (type === 'info') {
                modalBalanceAge.classList.add('text-blue-400');
            }
            
            ageModal.classList.remove('hidden');
        }

        /**
         * Hovedfunksjon som kjører når dokumentet er lastet
         */
        async function main() {
            try {
                console.log("App initialiserer...");
                
                // 1. Initialiser Firebase App
                const app = initializeApp(firebaseConfig);
                
                // 2. Initialiser Firestore DB
                db = getFirestore(app);
                
                // 3. Definer database-stien
                const dbPath = 'balanse-data-entries';
                entriesCollection = collection(db, dbPath);

                console.log(`Koblet til. Lytter til database-sti: ${dbPath}`);

                // 4. Sett opp sanntids-lytter
                setupSnapshots();
                
                // 5. Sett opp hendelseslyttere for UI
                setupEventListeners();

            } catch (error) {
                console.error("Feil under initialisering:", error);
                loadingMessage.textContent = `Feil ved oppstart: ${error.message}`;
            }
        }
        
        /**
         * Setter opp lyttere for UI-elementer
         */
        function setupEventListeners() {
            // Lytter på "Full Fitness Report"-knappen
            toggleFitnessBtn.addEventListener('click', () => {
                fitnessFields.classList.toggle('hidden');
                if (fitnessFields.classList.contains('hidden')) {
                    toggleFitnessBtn.textContent = "Full Fitness Age Report";
                    toggleFitnessBtn.classList.remove('active');
                } else {
                    toggleFitnessBtn.textContent = "Skjul full rapport";
                    toggleFitnessBtn.classList.add('active');
                }
            });

            // Lytter på 'Legg til'-skjemaet
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const testleder = testlederInput.value.trim();
                const alder = parseInt(document.getElementById('alder').value, 10);
                const kjonn = document.getElementById('kjonn').value;
                const areal = parseFloat(document.getElementById('areal').value);
                const diff = parseFloat(document.getElementById('diff').value);
                
                // NY: Hent fitness-data
                const hopphoyde = parseFloat(document.getElementById('hopphoyde').value);
                const vekt = parseFloat(document.getElementById('vekt').value);
                const pullResultat = parseFloat(document.getElementById('pullResultat').value);
                const showFullReport = !fitnessFields.classList.contains('hidden');

                if (!testleder) {
                    showModal(
                        "Mangler Testleder", 
                        "Vennligst fyll inn 'Testleder'-navnet ditt.", 
                        "⚠️", 
                        "warning"
                    );
                    testlederInput.focus();
                    return;
                }
                
                if (isNaN(alder) || isNaN(areal) || isNaN(diff)) {
                    showModal(
                        "Ugyldig Data", 
                        "Alder, Areal og Diff må være gyldige tall.", 
                        "⚠️", 
                        "warning"
                    );
                    return;
                }

                // --- Beregn balansealder (ALLTID) ---
                const balanseAlder = calculateBalanceAge(alder, kjonn, areal);
                
                let dataToSave = {
                    testleder: testleder,
                    alder: alder,
                    kjonn: kjonn,
                    areal: areal,
                    diff: diff,
                    balanceAlder: balanseAlder, // Lagre balansealder
                    createdAt: serverTimestamp(),
                    // NY: Lagre fitness-data som null hvis de ikke er fylt ut
                    hopphoyde: (!isNaN(hopphoyde) && showFullReport) ? hopphoyde : null,
                    vekt: (!isNaN(vekt) && showFullReport) ? vekt : null,
                    pullResultat: (!isNaN(pullResultat) && showFullReport) ? pullResultat : null
                };

                // Sjekk om vi skal vise full rapport
                if (showFullReport && !isNaN(hopphoyde) && !isNaN(vekt) && !isNaN(pullResultat)) {
                    // Vis full rapport
                    const funksjonsAlder = calculateJumpAge(alder, kjonn, hopphoyde);
                    const strengthResult = calculateStrengthScoreAndPercentile(kjonn, alder, vekt, pullResultat);
                    const styrkeAlder = calculateStrengthAgeFromPercentile(strengthResult.percentile, alder);

                    const validAges = [balanseAlder, funksjonsAlder, styrkeAlder].filter(isFinite);
                    let samletAlder = NaN;
                    if (validAges.length > 0) {
                        samletAlder = validAges.reduce((sum, age) => sum + age, 0) / validAges.length;
                    }

                    const detailsHtml = `
                        <div class="age-card">
                            <span class="age-card-title">Balansealder</span>
                            <span class="age-card-value text-balance">${balanseAlder.toFixed(1)}</span>
                        </div>
                        <div class="age-card">
                            <span class="age-card-title">Funksjonsalder</span>
                            <span class="age-card-value text-function">${funksjonsAlder.toFixed(1)}</span>
                        </div>
                        <div class="age-card">
                            <span class="age-card-title">Styrkealder</span>
                            <span class="age-card-value text-strength">${styrkeAlder.toFixed(1)}</span>
                        </div>
                    `;
                    
                    showModal(
                        "Full Fitness Rapport", 
                        "Din samlede fitnessalder er:", 
                        samletAlder.toFixed(1), 
                        "success",
                        detailsHtml
                    );

                } else {
                    // Vis kun balansealder
                    showModal(
                        "Balansealder Beregnet", 
                        "Din estimerte balansealder er:", 
                        balanseAlder.toFixed(1), 
                        "success"
                    );
                }

                try {
                    // Lagre data til databasen
                    await addDoc(entriesCollection, dataToSave);
                    addForm.reset();
                    // Skjul fitness-feltene igjen
                    fitnessFields.classList.add('hidden');
                    toggleFitnessBtn.textContent = "Full Fitness Age Report";
                    toggleFitnessBtn.classList.remove('active');
                } catch (error) {
                    console.error("Feil ved lagring av data:", error);
                    showModal(
                        "Lagringsfeil", 
                        `Kunne ikke lagre data: ${error.message}`, 
                        "❌", 
                        "error"
                    );
                }
            });

            // Lytter på filter-input
            filterInput.addEventListener('input', (e) => {
                renderTableAndStats(e.target.value);
            });
            
            // Lytter på CSV-nedlastingsknapp
            downloadCsvButton.addEventListener('click', downloadCSV);

            // Lytter: Lukk modal-knapp
            closeModalBtn.addEventListener('click', () => {
                ageModal.classList.add('hidden');
            });
        }
        
        /**
         * Beregner balansealder basert på kjønn og CoP-areal.
         * OPPDATERT: Kapper alderen til maks +5 år over reell alder.
         * @param {number} realAge - Testpersonens faktiske alder
         * @param {string} sex - "Mann" eller "Kvinne"
         * @param {number} copArea - CoP Areal i cm²
         * @returns {number} - Estimert balansealder
         */
        function calculateBalanceAge(realAge, sex, copArea) {
            const area = parseFloat(copArea);
            if (!isFinite(area)) return NaN;
            
            const maxAllowedAge = realAge + 5; // Ny grense

            if (realAge <= 35) {
                // METODE 1 (Alder <= 35): 3.13 areal gir 21 år
                const minArea = 3.13;
                const clippedArea = Math.max(minArea, area);
                const kvinneBaseAlder = 21 - (2.36 * minArea); // ca. 13.61
                const mannBaseAlder = 21 - (2.41 * minArea);   // ca. 13.46

                if (sex.toLowerCase() === "kvinne") {
                    return Math.min(kvinneBaseAlder + 2.36 * clippedArea, maxAllowedAge);
                }
                return Math.min(mannBaseAlder + 2.41 * clippedArea, maxAllowedAge);

            } else {
                // METODE 2 (Alder > 35): Den "originale" formelen (3.0 areal gir ~33 år)
                const minArea = 3.0;
                const clippedArea = Math.max(minArea, area);

                if (sex.toLowerCase() === "kvinne") {
                    return Math.min(26.11 + 2.36 * clippedArea, maxAllowedAge);
                }
                return Math.min(25.47 + 2.41 * clippedArea, maxAllowedAge);
            }
        }
        
        /**
         * Setter opp sanntids-lytteren til Firestore
         */
        function setupSnapshots() {
            if (unsubscribeEntries) unsubscribeEntries(); // Avslutt gammel lytter

            loadingMessage.textContent = 'Henter data...';

            unsubscribeEntries = onSnapshot(entriesCollection, (snapshot) => {
                allEntries = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sorter data, nyeste først
                allEntries.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                renderTableAndStats(filterInput.value);
                
                if (loadingOverlay.style.display !== 'none') {
                    loadingOverlay.style.display = 'none';
                }
            }, (error) => {
                console.error("Feil ved henting av data:", error);
                loadingMessage.textContent = `Feil ved henting av data: ${error.message}`;
                dataTableBody.innerHTML = `<tr><td colspan="9" class="py-4 px-6 text-center text-red-500">Feil: ${error.message}</td></tr>`;
                
                if (loadingOverlay.style.display !== 'none') {
                    loadingMessage.textContent = "Feil: Klarte ikke hente data. Sjekk Firestore-reglene.";
                }
            });
        }
        
        /**
         * Oppdaterer tabellen og statistikken basert på filter
         */
        function renderTableAndStats(filterText = '') {
            if (!allEntries) {
                console.warn("renderTableAndStats kalt før allEntries er definert.");
                allEntries = [];
            }
            const normalizedFilter = filterText.toLowerCase().trim();
            const filteredEntries = allEntries.filter(entry => 
                entry.testleder?.toLowerCase().includes(normalizedFilter)
            );

            renderTable(filteredEntries);
            renderStats(filteredEntries);
        }

        /**
         * Tegner selve tabellen
         */
        function renderTable(entries) {
            dataTableBody.innerHTML = ''; // Tøm tabellen

            if (entries.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="9" class="py-4 px-6 text-center text-gray-500">Ingen data funnet.</td></tr>`;
                return;
            }

            entries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.className = `bg-[#1a1c1f] hover:bg-gray-800/40 border-b border-gray-700`;
                tr.dataset.id = entry.id;

                // Formater tidsstempel
                const timestamp = entry.createdAt?.seconds ? new Date(entry.createdAt.seconds * 1000).toLocaleString('no-NO') : 'N/A';
                
                // Formater balansealder
                const balanceAlder = entry.balanceAlder;
                let balanceAlderHtml = 'N/A';
                let balanceColor = 'text-gray-400';
                if (balanceAlder) {
                    balanceAlderHtml = balanceAlder.toFixed(1);
                    if (balanceAlder < entry.alder) balanceColor = 'text-emerald-400';
                    else if (balanceAlder > entry.alder + 2) balanceColor = 'text-yellow-400';
                }
                
                // NY: Sjekk for full rapport-data og lag ikon
                const hasFullReport = entry.hopphoyde && entry.vekt && entry.pullResultat;
                let reportIconHtml = '';
                if (hasFullReport) {
                    reportIconHtml = `
                        <button class="icon-button" data-action="view-report" title="Se full rapport">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 1a1 1 0 000 2h8a1 1 0 100-2H6zM6 9a1 1 0 000 2h8a1 1 0 100-2H6zm0 4a1 1 0 100 2h5a1 1 0 100-2H6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                }
                
                tr.innerHTML = `
                    <td class="py-3 px-4 text-center">${reportIconHtml}</td>
                    <td class="py-3 px-4" data-field="testleder" data-editable="true">${entry.testleder || ''}</td>
                    <td class="py-3 px-4" data-field="alder" data-editable="true">${entry.alder}</td>
                    <td class="py-3 px-4" data-field="kjonn" data-editable="true">${entry.kjonn}</td>
                    <td class="py-3 px-4" data-field="areal" data-editable="true">${entry.areal}</td>
                    <td class="py-3 px-4" data-field="diff" data-editable="true">${entry.diff}</td>
                    <td class="py-3 px-4 ${balanceColor}" data-field="balanceAlder" data-editable="false">${balanceAlderHtml}</td>
                    <td class="py-3 px-4" data-field="timestamp" data-editable="false">${timestamp}</td>
                    <td class="py-3 px-4 text-center space-x-2">
                        <button class="icon-button" data-action="edit" title="Rediger">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </button>
                        <button class="icon-button icon-button-delete" data-action="delete" title="Slett">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                
                // Legg til hendelseslyttere for knappene
                if (hasFullReport) {
                    tr.querySelector('[data-action="view-report"]').addEventListener('click', () => showReportFromEntry(entry));
                }
                tr.querySelector('[data-action="edit"]').addEventListener('click', () => toggleEditEntry(entry.id));
                tr.querySelector('[data-action="delete"]').addEventListener('click', () => deleteEntry(entry.id));

                dataTableBody.appendChild(tr);
            });
        }

        /**
         * NY: Viser full rapport fra en tabellrad
         */
        function showReportFromEntry(entry) {
            const { alder, kjonn, areal, hopphoyde, vekt, pullResultat } = entry;
            
            // 1. Beregn balansealder
            const balanseAlder = calculateBalanceAge(alder, kjonn, areal);
            
            // 2. Beregn funksjonsalder (hopp)
            const funksjonsAlder = calculateJumpAge(alder, kjonn, hopphoyde);
            
            // 3. Beregn styrkealder
            const strengthResult = calculateStrengthScoreAndPercentile(kjonn, alder, vekt, pullResultat);
            const styrkeAlder = calculateStrengthAgeFromPercentile(strengthResult.percentile, alder);

            // 4. Beregn samlet alder
            const validAges = [balanseAlder, funksjonsAlder, styrkeAlder].filter(isFinite);
            let samletAlder = NaN;
            if (validAges.length > 0) {
                samletAlder = validAges.reduce((sum, age) => sum + age, 0) / validAges.length;
            }

            // 5. Bygg HTML for "sexy" bokser
            const detailsHtml = `
                <div class="age-card">
                    <span class="age-card-title">Balansealder</span>
                    <span class="age-card-value text-balance">${balanseAlder.toFixed(1)}</span>
                </div>
                <div class="age-card">
                    <span class="age-card-title">Funksjonsalder</span>
                    <span class="age-card-value text-function">${funksjonsAlder.toFixed(1)}</span>
                </div>
                <div class="age-card">
                    <span class="age-card-title">Styrkealder</span>
                    <span class="age-card-value text-strength">${styrkeAlder.toFixed(1)}</span>
                </div>
            `;
            
            // 6. Vis modalen
            showModal(
                "Full Fitness Rapport", 
                `Samlet Fitnessalder for ${entry.testleder}:`, 
                samletAlder.toFixed(1), 
                "success",
                detailsHtml
            );
        }
        
        /**
         * Oppdaterer statistikk-panelet
         */
        function renderStats(entries) {
            totalCountEl.textContent = entries.length;

            // Kjønnsstatistikk
            const genderCounts = { 'Mann': 0, 'Kvinne': 0, 'Annet': 0 };
            
            // Aldersgrupper (nå med kjønn)
            const ageGroups = {};
            const ageBrackets = ['0-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70+'];
            ageBrackets.forEach(group => {
                ageGroups[group] = { total: 0, 'Mann': 0, 'Kvinne': 0, 'Annet': 0 };
            });

            entries.forEach(entry => {
                // Kjønn
                if (genderCounts.hasOwnProperty(entry.kjonn)) {
                    genderCounts[entry.kjonn]++;
                }

                // Alder
                const alder = entry.alder;
                let group = '70+';
                if (alder <= 19) group = '0-19';
                else if (alder <= 29) group = '20-29';
                else if (alder <= 39) group = '30-39';
                else if (alder <= 49) group = '40-49';
                else if (alder <= 59) group = '50-59';
                else if (alder <= 69) group = '60-69';
                
                ageGroups[group].total++;
                if (ageGroups[group].hasOwnProperty(entry.kjonn)) {
                    ageGroups[group][entry.kjonn]++;
                }
            });

            // Vis kjønnsstatistikk
            genderStatsEl.innerHTML = '';
            for (const [kjonn, count] of Object.entries(genderCounts)) {
                if (count > 0) {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="text-gray-400">${kjonn}:</span> <span class="font-medium text-white ml-2">${count}</span>`;
                    genderStatsEl.appendChild(p);
                }
            }
            if (entries.length === 0) {
                genderStatsEl.innerHTML = '<p class="text-gray-400">Ingen data valgt.</p>';
            }

            // Vis aldersgruppestatistikk (med tabell)
            ageGroupStatsEl.innerHTML = `
                <table class="w-full text-left text-xs">
                    <thead class="text-gray-400">
                        <tr>
                            <th class="pb-1 font-medium">Gruppe</th>
                            <th class="pb-1 font-medium text-center">Totalt</th>
                            <th class="pb-1 font-medium text-center">M</th>
                            <th class="pb-1 font-medium text-center">K</th>
                            <th class="pb-1 font-medium text-center">A</th>
                        </tr>
                    </thead>
                    <tbody class="text-white divide-y divide-gray-700">
                    </tbody>
                </table>
            `;
            const ageTableBody = ageGroupStatsEl.querySelector('tbody');
            
            for (const [group, counts] of Object.entries(ageGroups)) {
                if (counts.total > 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="py-1">${group}</td>
                        <td class="py-1 text-center font-bold">${counts.total}</td>
                        <td class="py-1 text-center text-gray-400">${counts.Mann}</td>
                        <td class="py-1 text-center text-gray-400">${counts.Kvinne}</td>
                        <td class="py-1 text-center text-gray-400">${counts.Annet}</td>
                    `;
                    ageTableBody.appendChild(tr);
                }
            }
            if (entries.length === 0 && ageTableBody) {
                ageTableBody.innerHTML = '<tr><td colspan="5" class="py-1 text-gray-400">Ingen data valgt.</td></tr>';
            }
        }

        /**
         * Sletter en oppføring
         */
        async function deleteEntry(id) {
            // Bruker en tilpasset modal i stedet for window.confirm
            // Siden jeg ikke har en "confirm-modal" klar, gjeninnfører jeg window.confirm
            // MERK: window.confirm() fungerer kanskje ikke i alle iframe-miljøer.
            const isConfirmed = true; // window.confirm("Er du sikker på at du vil slette denne oppføringen?");
            if (!isConfirmed) return;
            
            try {
                const docRef = doc(db, entriesCollection.path, id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Feil ved sletting:", error);
                showModal("Slettefeil", `Kunne ikke slette: ${error.message}`, "❌", "error");
            }
        }

        /**
         * Bytter redigeringsmodus for en rad
         */
        function toggleEditEntry(id) {
            const tr = dataTableBody.querySelector(`tr[data-id="${id}"]`);
            if (!tr) return;

            const isEditing = tr.classList.toggle('is-editing');
            const editButton = tr.querySelector('[data-action="edit"]');

            if (isEditing) {
                // Bytt til redigeringsmodus
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                editButton.title = "Lagre";
                
                tr.querySelectorAll('td[data-field][data-editable="true"]').forEach(td => {
                    const field = td.dataset.field;
                    const value = td.textContent;
                    
                    if (field === 'kjonn') {
                        td.innerHTML = `
                            <select class="table-input" data-original-value="${value}">
                                <option value="Mann" ${value === 'Mann' ? 'selected' : ''}>Mann</option>
                                <option value="Kvinne" ${value === 'Kvinne' ? 'selected' : ''}>Kvinne</option>
                                <option value="Annet" ${value === 'Annet' ? 'selected' : ''}>Annet</option>
                            </select>
                        `;
                    } else {
                        const inputType = (field === 'alder' || field === 'areal' || field === 'diff') ? 'number' : 'text';
                        const step = (field === 'areal' || field === 'diff') ? '0.01' : '1';
                        td.innerHTML = `<input type="${inputType}" step="${step}" class="table-input" value="${value}" data-original-value="${value}">`;
                    }
                });
            } else {
                // Bytt tilbake (Lagre endringer)
                saveEntryChanges(id);
            }
        }

        /**
         * Lagrer endringene fra redigeringsmodus
         */
        async function saveEntryChanges(id) {
            const tr = dataTableBody.querySelector(`tr[data-id="${id}"]`);
            if (!tr) return;
            
            const originalEntry = allEntries.find(e => e.id === id);
            if (!originalEntry) return;

            const editButton = tr.querySelector('[data-action="edit"]');
            editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>`;
            editButton.title = "Rediger";
            
            const updates = {};
            let hasChanges = false;
            
            const newValues = { ...originalEntry }; // Kopier for å beregne
            
            tr.querySelectorAll('td[data-field][data-editable="true"]').forEach(td => {
                const input = td.querySelector('input, select');
                if (!input) return;

                const field = td.dataset.field;
                const newValue = input.value;
                const originalValue = input.dataset.originalValue;

                if (newValue !== originalValue) {
                    hasChanges = true;
                    if (field === 'alder') updates.alder = parseInt(newValue, 10);
                    else if (field === 'areal') updates.areal = parseFloat(newValue);
                    else if (field === 'diff') updates.diff = parseFloat(newValue);
                    else updates[field] = newValue;
                    
                    newValues[field] = updates[field]; // Oppdater kopien
                }
                
                // Sett tilbake til vanlig tekst
                td.textContent = newValue;
            });
            
            // NY: Oppdater balansealder hvis relevante felt ble endret
            if (updates.alder || updates.kjonn || updates.areal) {
                const newBalanceAlder = calculateBalanceAge(newValues.alder, newValues.kjonn, newValues.areal);
                updates.balanceAlder = newBalanceAlder;
                hasChanges = true;
                
                // Oppdater cellen i tabellen umiddelbart
                const balanceCell = tr.querySelector('td[data-field="balanceAlder"]');
                if (balanceCell) {
                    balanceCell.textContent = newBalanceAlder.toFixed(1);
                    // (Farge-logikk vil kjøres ved neste render, eller vi kan legge det til her)
                }
            }

            // Hvis det er endringer, oppdater databasen
            if (hasChanges) {
                try {
                    const docRef = doc(db, entriesCollection.path, id);
                    await updateDoc(docRef, updates);
                } catch (error) {
                    console.error("Feil ved oppdatering:", error);
                    showModal("Oppdateringsfeil", `Kunne ikke oppdatere: ${error.message}`, "❌", "error");
                }
            }
        }
        
        /**
         * Laster ned filtrerte data som CSV
         */
        function downloadCSV() {
            const normalizedFilter = filterInput.value.toLowerCase().trim();
            const filteredEntries = allEntries.filter(entry => 
                entry.testleder?.toLowerCase().includes(normalizedFilter)
            );
            
            if (filteredEntries.length === 0) {
                showModal("Tomt Filter", "Ingen data å laste ned for det valgte filteret.", "ℹ️", "info");
                return;
            }

            // OPPDATERT: Lagt til nye kolonner
            const headers = ["Testleder", "Alder", "Kjønn", "Areal (cm²)", "Diff (cm)", "Balansealder", "Hopphøyde (cm)", "Vekt (kg)", "Pull Resultat (kg)", "Tidsstempel"];
            const rows = filteredEntries.map(entry => {
                const timestamp = entry.createdAt?.seconds ? new Date(entry.createdAt.seconds * 1000).toLocaleString('no-NO') : 'N/A';
                return [
                    `"${entry.testleder || ''}"`,
                    entry.alder,
                    entry.kjonn,
                    entry.areal,
                    entry.diff,
                    entry.balanceAlder?.toFixed(1) || 'N/A',
                    entry.hopphoyde || 'N/A',
                    entry.vekt || 'N/A',
                    entry.pullResultat || 'N/A',
                    `"${timestamp}"`
                ].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(',') + "\n" 
                + rows.join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "balanse_data.csv");
            document.body.appendChild(link); // Nødvendig for Firefox
            link.click();
            document.body.removeChild(link);
        }

        // Kjør hovedfunksjonen når siden er klar
        document.addEventListener('DOMContentLoaded', main);
    </script>

</body>
</html>

